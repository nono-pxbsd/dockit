#!/bin/bash

# Script de mise √† jour des modules PrestaShop via l'API Addons
# Usage: ./prestashop-module-update PROJECT_NAME [--auto]

PROJECT_NAME="${1:-dockit-auto}"
AUTO_MODE=false

# V√©rifier le flag --auto
if [[ "$2" == "--auto" ]] || [[ "$1" == "--auto" ]]; then
  AUTO_MODE=true
  PROJECT_NAME="${1:-dockit-auto}"
  [[ "$1" == "--auto" ]] && PROJECT_NAME="dockit-auto"
fi

# Couleurs
GREEN="\e[32m"
RED="\e[31m"
CYAN="\e[36m"
YELLOW="\e[33m"
BOLD="\e[1m"
RESET="\e[0m"

echo -e "${BOLD}${CYAN}üîÑ Mise √† jour des modules PrestaShop${RESET}"
echo -e "Projet: ${GREEN}${PROJECT_NAME}${RESET}"
echo ""

# V√©rifier que le container existe
if ! docker ps --filter "name=${PROJECT_NAME}_php" --format "{{.Names}}" | grep -q "${PROJECT_NAME}_php"; then
  echo -e "${RED}‚ùå Container ${PROJECT_NAME}_php introuvable${RESET}"
  exit 1
fi

echo -e "üîç ${BOLD}Recherche des mises √† jour disponibles via API Addons...${RESET}"

# Chemin du script (relatif √† ce fichier)
SCRIPT_DIR="$( cd "$( dirname "$(readlink -f "${BASH_SOURCE[0]}" )" )" && pwd )"
PHP_CHECK_SCRIPT="$SCRIPT_DIR/../lib/prestashop-check-updates.php"

# Copier le script PHP dans le container
docker cp "$PHP_CHECK_SCRIPT" "${PROJECT_NAME}_php:/tmp/check-updates.php" >/dev/null 2>&1

# Ex√©cuter le script et nettoyer
RESULT=$(docker exec "${PROJECT_NAME}_php" bash -c "php /tmp/check-updates.php 2>&1 && rm -f /tmp/check-updates.php")

# V√©rifier les erreurs
if echo "$RESULT" | grep -q "^ERROR:"; then
  echo -e "${RED}‚ùå Erreur lors de la r√©cup√©ration des mises √† jour${RESET}"
  ERROR_MSG=$(echo "$RESULT" | grep "^ERROR:" | sed 's/^ERROR://')
  echo -e "${YELLOW}D√©tails: $ERROR_MSG${RESET}"
  exit 1
fi

# Filtrer les lignes valides (contenant |)
MODULES_TO_UPDATE=$(echo "$RESULT" | grep "|")

if [ -z "$MODULES_TO_UPDATE" ]; then
  echo -e "${GREEN}‚úÖ Aucune mise √† jour disponible !${RESET}"
  exit 0
fi

MODULE_COUNT=$(echo "$MODULES_TO_UPDATE" | wc -l)
echo -e "${YELLOW}‚ö†Ô∏è  ${MODULE_COUNT} module(s) peuvent √™tre mis √† jour${RESET}"
echo ""

# Afficher les modules
echo -e "${BOLD}Modules disponibles pour mise √† jour :${RESET}"
echo "$MODULES_TO_UPDATE" | while IFS='|' read -r name display_name version_current version_available; do
  echo -e "  ‚Ä¢ ${CYAN}$name${RESET} ($display_name) : v$version_current ‚Üí v$version_available"
done
echo ""

# Demander confirmation (sauf en mode auto)
if [ "$AUTO_MODE" = false ]; then
  read -p "Voulez-vous mettre √† jour ces modules ? (y/N) " CONFIRM
  if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}‚è≠Ô∏è  Mise √† jour annul√©e${RESET}"
    exit 0
  fi
fi

echo ""
echo -e "${BOLD}${CYAN}üî® Mise √† jour des modules...${RESET}"
echo ""

# Mettre √† jour chaque module
SUCCESS_COUNT=0
FAIL_COUNT=0

echo "$MODULES_TO_UPDATE" | while IFS='|' read -r name display_name version_current version_available; do
  # Ignorer les lignes vides ou invalides
  if [ -z "$name" ] || [ -z "$display_name" ]; then
    continue
  fi

  echo -e "  Mise √† jour de ${CYAN}${name}${RESET} (${display_name}) : v$version_current ‚Üí v$version_available"

  # Copier le script d'upgrade dans le container
  PHP_UPGRADE_SCRIPT="$SCRIPT_DIR/../lib/prestashop-upgrade-module.php"
  docker cp "$PHP_UPGRADE_SCRIPT" "${PROJECT_NAME}_php:/tmp/upgrade-module.php" >/dev/null 2>&1

  # Ex√©cuter l'upgrade et nettoyer
  RESULT=$(docker exec "${PROJECT_NAME}_php" bash -c "php /tmp/upgrade-module.php '$name' 2>&1 && rm -f /tmp/upgrade-module.php")

  if [ "$RESULT" = "SUCCESS" ]; then
    echo -e "    ${GREEN}‚úÖ Mis √† jour avec succ√®s${RESET}"
    ((SUCCESS_COUNT++))
  else
    echo -e "    ${RED}‚ùå √âchec de la mise √† jour${RESET}"
    if echo "$RESULT" | grep -q "ERROR:"; then
      ERROR_MSG=$(echo "$RESULT" | sed 's/^ERROR://')
      echo -e "    ${YELLOW}D√©tails: $ERROR_MSG${RESET}"
    fi
    ((FAIL_COUNT++))
  fi
  echo ""
done

echo ""
echo -e "${BOLD}${CYAN}üìä R√©sum√© :${RESET}"
echo -e "  ${GREEN}‚úÖ Succ√®s : ${SUCCESS_COUNT}${RESET}"
if [ $FAIL_COUNT -gt 0 ]; then
  echo -e "  ${RED}‚ùå √âchecs : ${FAIL_COUNT}${RESET}"
fi
echo ""
echo -e "${GREEN}‚úÖ Termin√© !${RESET}"
